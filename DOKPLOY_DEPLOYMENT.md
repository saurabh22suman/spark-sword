# PrepRabbit Dokploy Deployment Guide

## Prerequisites

- Dokploy installed and running
- Domain names configured and pointing to your server
- SSL certificates will be auto-generated by Dokploy/Traefik

## Step 1: Create Project in Dokploy

1. Log into your Dokploy dashboard
2. Click **"Create Project"**
3. Name it: `preprabbit`

## Step 2: Add Docker Compose Service

1. In the project, click **"Add Service"** â†’ **"Docker Compose"**
2. **General Tab:**
   - **Name:** `preprabbit`
   - **Repository:** Select your Git repository
   - **Branch:** `main` (or your production branch)
   - **Docker Compose Path:** `docker-compose-prod.yml`

3. **Environment Tab:**
   Copy and paste from `.env.production`, replacing with your actual domains:
   ```env
   FRONTEND_DOMAIN=spark.preprabbit.in
   BACKEND_DOMAIN=api.spark.preprabbit.in
   NEXT_PUBLIC_API_URL=https://api.spark.preprabbit.in
   CORS_ORIGINS=https://spark.preprabbit.in
   NODE_ENV=production
   PYTHONUNBUFFERED=1
   ```

4. **Domains Tab:**
   Add two domains:
   - **Frontend:** `spark.preprabbit.in` â†’ Container: `frontend`, Port: `3000`
   - **Backend:** `api.spark.preprabbit.in` â†’ Container: `backend`, Port: `8000`
   
   âœ… Enable **"Generate SSL"** for both domains

## Step 3: Configure DNS

Add these DNS records to your domain provider:

```
Type    Name                            Value
A       spark.preprabbit.in      YOUR_SERVER_IP
A       api.spark.preprabbit.in  YOUR_SERVER_IP
```

Or if using a subdomain:
```
Type    Name                Value
A       @                   YOUR_SERVER_IP
CNAME   api                 yourdomain.com
```

## Step 4: Deploy

1. In Dokploy, go to **Deployments** tab
2. Click **"Deploy"**
3. Watch the build logs in real-time
4. Wait for both services to become healthy (green checkmarks)

## Step 5: Verify Deployment

Check these URLs:
- âœ… Frontend: `https://spark.preprabbit.in`
- âœ… Backend API: `https://api.spark.preprabbit.in/health`
- âœ… API Docs: `https://api.spark.preprabbit.in/docs`

## Volume Backups (Optional but Recommended)

Your data is stored in the `backend_data` named volume.

To enable automated backups:
1. Go to **Server** â†’ **S3 Destinations**
2. Add your S3 credentials (AWS, Backblaze, DigitalOcean Spaces, etc.)
3. Go to **Volume Backups** tab in your service
4. Create a backup schedule (e.g., daily at 2 AM)

## Auto-Deploy from Git (Recommended)

1. Go to **General** tab
2. Enable **"Auto Deploy"**
3. Copy the webhook URL
4. Add it to your GitHub repository:
   - Settings â†’ Webhooks â†’ Add webhook
   - Paste the Dokploy webhook URL
   - Select: "Just the push event"
   - Save

Now every push to your branch will automatically deploy! ðŸš€

## Monitoring

- **Logs:** Go to **Logs** tab to view real-time logs for each service
- **Monitoring:** Go to **Monitoring** tab to see CPU/Memory usage
- **Health Checks:** Services will auto-restart if health checks fail

## Troubleshooting

### Build fails
- Check **Logs** tab for build errors
- Verify environment variables are set correctly
- Ensure Dockerfile paths are correct

### Services not accessible
- Verify DNS records have propagated (use `dig` or `nslookup`)
- Check **Domains** tab - SSL certificates should be green
- View **Logs** for connection errors

### Backend can't connect to database
- Check **Advanced** â†’ **Volumes** to ensure `backend_data` volume exists
- View backend logs: `Could not connect to database`

### Frontend shows "Failed to fetch"
- Verify `NEXT_PUBLIC_API_URL` points to your backend domain
- Check CORS settings in backend
- Open browser console for error details

## Updating the Application

### Method 1: Git Push (with Auto-Deploy enabled)
```bash
git add .
git commit -m "Update application"
git push origin main
```
Dokploy will automatically detect and deploy.

### Method 2: Manual Deploy
1. Push your changes to Git
2. In Dokploy, go to **Deployments** tab
3. Click **"Deploy"** button

## Environment Variables Reference

| Variable | Description | Example |
|----------|-------------|---------|
| `FRONTEND_DOMAIN` | Your frontend domain | `preprabbit.example.com` |
| `BACKEND_DOMAIN` | Your API domain | `api.preprabbit.example.com` |
| `NEXT_PUBLIC_API_URL` | Backend URL for frontend | `https://api.preprabbit.example.com` |
| `CORS_ORIGINS` | Allowed CORS origins | `https://preprabbit.example.com` |

## Scaling (Optional)

To run multiple replicas:
1. Go to **Advanced** tab
2. In **Command** field, add: `--scale frontend=3 --scale backend=2`
3. Redeploy

## Next Steps

After successful deployment:
- [ ] Set up monitoring alerts
- [ ] Configure volume backups
- [ ] Set up auto-deploy webhook
- [ ] Add Google OAuth (requires updating environment variables)
- [ ] Set up staging environment (separate project with different domains)

## Support

- Dokploy Docs: https://docs.dokploy.com
- Discord: https://discord.gg/dokploy
- GitHub: https://github.com/Dokploy/dokploy
