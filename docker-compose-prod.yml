version: "3.9"

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    networks:
      - dokploy-network

    environment:
      PYTHONUNBUFFERED: 1
      ENV: production
      API_HOST: 0.0.0.0
      API_PORT: 8000
      
      # Database paths
      DUCKDB_PATH: /app/data/spark_sword.duckdb
      PROGRESS_DB_PATH: /app/data/progress.duckdb
      
      # CORS
      ALLOWED_ORIGINS: ${CORS_ORIGINS:-https://spark.preprabbit.in}
      
      # Debug
      DEBUG: ${DEBUG:-false}

    volumes:
      - backend_data:/app/data

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 3s
      retries: 3

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.preprabbit-backend.rule=Host(`${BACKEND_DOMAIN}`) && PathPrefix(`/api`, `/health`, `/expert`, `/scenarios`, `/tutorials`)"
      - "traefik.http.routers.preprabbit-backend.entrypoints=websecure"
      - "traefik.http.routers.preprabbit-backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.preprabbit-backend.loadbalancer.server.port=8000"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    networks:
      - dokploy-network

    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      PORT: 3000
      HOSTNAME: 0.0.0.0

    depends_on:
      backend:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 3s
      retries: 3

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.preprabbit-frontend.rule=Host(`${FRONTEND_DOMAIN}`)"
      - "traefik.http.routers.preprabbit-frontend.entrypoints=websecure"
networks:
  dokploy-network:
    external: true

volumes:
  backend_data:
networks:
  preprabbit_network:
    driver: bridge
